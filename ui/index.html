<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Unified Cost Center</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="backdrop"></div>
    <main class="app">
      <header class="hero">
        <div>
          <p class="eyebrow">Unified Cost Center</p>
          <h1>Main Menu</h1>
          <p class="subtitle">Choose an area to explore engineering spend.</p>
        </div>
      </header>

      <section class="landing">
        <div class="landing-actions">
          <a class="action-card" href="dashboard.html#overview">Hosting</a>
          <a class="action-card" href="ai.html">AI</a>
          <a class="action-card" href="third-parties.html">3rd parties</a>
        </div>
        <div class="panel landing-widget">
          <h3>Total engineering spend</h3>
          <div class="spend-grid">
          <div class="spend-item">
            <span>This month (forecast)</span>
            <strong id="engineeringSpendForecast">—</strong>
          </div>
          <div class="spend-split">
            <div class="spend-split-header">
              <span>Forecast split</span>
              <strong id="engineeringSpendSplitLabel">—</strong>
            </div>
            <div class="spend-split-bar" aria-label="Forecast split">
              <div class="spend-split-fill spent" id="engineeringSpendSplitSpent">
                <span id="engineeringSpendSplitSpentPct">—</span>
              </div>
            </div>
            <div class="spend-split-legend">
              <span class="legend-item"><span class="legend-dot spent"></span>Spent</span>
              <span class="legend-item"><span class="legend-dot remaining"></span>Remaining</span>
            </div>
          </div>
          <div class="spend-item">
            <span>Previous month</span>
            <strong id="engineeringSpendPrevious">—</strong>
          </div>
          <div class="spend-item">
            <span>Month to date</span>
            <strong id="engineeringSpendMTD">—</strong>
          </div>
        </div>
        <p class="caption">Forecast uses average daily spend from month-to-date.</p>
      </div>
      </section>
    </main>
    <script>
      const API_BASE = "http://localhost:8000";
      const spendForecastEl = document.getElementById("engineeringSpendForecast");
      const spendPreviousEl = document.getElementById("engineeringSpendPrevious");
      const spendMtdEl = document.getElementById("engineeringSpendMTD");
      const spendSplitSpentEl = document.getElementById("engineeringSpendSplitSpent");
      const spendSplitLabelEl = document.getElementById("engineeringSpendSplitLabel");
      const spendSplitSpentPctEl = document.getElementById("engineeringSpendSplitSpentPct");

      function formatCost(value, currency = "USD") {
        const formatter = new Intl.NumberFormat(undefined, {
          style: "currency",
          currency,
          notation: value >= 10000 ? "compact" : "standard",
          maximumFractionDigits: value >= 10000 ? 1 : 2,
        });
        return formatter.format(value);
      }

      async function fetchJson(path) {
        const apiKey = localStorage.getItem("uccc_api_key");
        const response = await fetch(`${API_BASE}${path}`, {
          headers: apiKey ? { "X-API-Key": apiKey } : {},
        });
        if (!response.ok) {
          throw new Error(`Failed to fetch ${path}`);
        }
        return response.json();
      }

      function toISODate(value) {
        return value.toISOString().slice(0, 10);
      }

      function getMonthStart(value) {
        return new Date(value.getFullYear(), value.getMonth(), 1);
      }

      function getMonthEnd(value) {
        return new Date(value.getFullYear(), value.getMonth() + 1, 0);
      }

      async function loadEngineeringSpend() {
        if (
          !spendForecastEl ||
          !spendPreviousEl ||
          !spendMtdEl ||
          !spendSplitSpentEl ||
          !spendSplitLabelEl ||
          !spendSplitSpentPctEl
        ) {
          return;
        }
        const today = new Date();
        const monthStart = getMonthStart(today);
        const monthEnd = getMonthEnd(today);
        const prevMonthStart = getMonthStart(new Date(today.getFullYear(), today.getMonth() - 1, 1));
        const prevMonthEnd = getMonthEnd(new Date(today.getFullYear(), today.getMonth() - 1, 1));
        try {
          const [mtd, previous] = await Promise.all([
            fetchJson(`/costs/total?from=${toISODate(monthStart)}&to=${toISODate(today)}`),
            fetchJson(`/costs/total?from=${toISODate(prevMonthStart)}&to=${toISODate(prevMonthEnd)}`),
          ]);
          const daysElapsed = Math.max(1, today.getDate());
          const daysInMonth = monthEnd.getDate();
          const mtdTotal = mtd.total_cost || 0;
          const forecast = (mtdTotal / daysElapsed) * daysInMonth;
          const remaining = Math.max(0, forecast - mtdTotal);
          const spentPct = forecast > 0 ? Math.min(100, (mtdTotal / forecast) * 100) : 0;
          spendMtdEl.textContent = formatCost(mtdTotal, "USD");
          spendPreviousEl.textContent = formatCost(previous.total_cost || 0, "USD");
          spendForecastEl.textContent = formatCost(forecast, "USD");
          spendSplitSpentEl.style.width = `${spentPct.toFixed(1)}%`;
          spendSplitLabelEl.textContent = `${formatCost(mtdTotal, "USD")} spent · ${formatCost(remaining, "USD")} remaining`;
          spendSplitSpentPctEl.textContent = `${spentPct.toFixed(0)}%`;
        } catch (error) {
          console.error(error);
          spendMtdEl.textContent = "—";
          spendPreviousEl.textContent = "—";
          spendForecastEl.textContent = "—";
          spendSplitLabelEl.textContent = "—";
          spendSplitSpentEl.style.width = "0%";
          spendSplitSpentPctEl.textContent = "—";
        }
      }

      loadEngineeringSpend();
    </script>
  </body>
</html>
